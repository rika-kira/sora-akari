import{r as a,j as e,R as M,c as b}from"./index-BPYevVv_.js";function E(){const[s,t]=a.useState(!1);return e.jsx(e.Fragment,{children:e.jsx("div",{id:"cap",className:s?"show":"hidden",onClick:()=>t(!s),children:e.jsxs("div",{className:"capMsg",children:["▼",e.jsx("br",{}),"かんじたことを とばす",e.jsx("br",{}),"どこに とぶかは わからない",e.jsx("br",{}),"もしかしたら だれかに とどくかも",e.jsx("br",{}),"だれかの きもちも とどくかも"]})})})}const R=M.memo(({newMessage:s})=>{const t=a.useRef(null),n=a.useRef([]),g=a.useRef(0);return a.useEffect(()=>{let d;const i=t.current;if(!i)return;const v=i.getContext("2d");if(s!=null&&s!=""&&s.message!=""){let c=new W(s.type,s.message,new Date),l=-1;if(n.current.length>0){const y=n.current.slice().sort((o,r)=>o.x-r.x);let m=0,h=5;for(let o=0;o<y.length;o++){const r=y[o];if(r.x-m>=c.msgWidth+h*2){l=m+h;continue}m=r.x+r.msgWidth}if(i.width-m>=c.msgWidth+h&&(l=m+h),l==-1){let o=Math.floor(i.width/c.msgWidth),r=Math.floor(Math.random()*o);c.x=r*c.msgWidth,console.log("初期位置確認")}else{let o=i.width-l;if(o>c.msgWidth){let r=Math.floor(o/c.msgWidth),u=Math.floor(Math.random()*r);l=l+u*c.msgWidth}c.x=l,console.log("隙間")}}n.current.push(c)}const S=()=>{const c=i.parentElement,l=c.clientWidth,y=c.clientHeight;i.width=l,i.height=y,i.style.width=`${l}px`,i.style.height=`${y}px`,v.clearRect(0,0,i.width,i.height);const m=new Date,h=20,o=25;let r=-1;n.current.forEach((u,f)=>{let x=(m-u.timeStart)/1e3;if(x<=h)u.transparent=1;else{const p=Math.min((x-h)/(o-h),1);u.transparent=parseFloat((1-p).toFixed(2))}x>=30&&(r=f)}),r>=0&&n.current.splice(r,1),n.current.forEach((u,f)=>{u.drawMessage(v),u.getP(y-5)}),g.current+=1,d=requestAnimationFrame(S)};return S(),()=>cancelAnimationFrame(d)},[s]),e.jsx("canvas",{ref:t,style:{width:"100%",height:"100%"}})});class W{constructor(t,n,g){this.type=t,this.message=n,this.timeStart=g,this.x=50,this.y=50,this.size=15,this.color="#28343bff",this.msgWidth=this.size*this.message.length,this.transparent=1,this.count=0,this.countMax=100,this.startX=0,this.startY=0,this.vy=0,this.gravity=.6,this.bounceFactor=.5}setPosition(t,n){this.x=t,this.y=n}setEmotion(t){this.emotion=t}setSize(t){this.size=t}setColor(t){this.color=t}drawMessage(t){this.sec=(new Date-this.timeStart)/1e3,t.font=this.size+"px DotGothic16",t.fillStyle=this.color,t.globalAlpha=this.transparent,t.fillText(this.message,this.x,this.y)}setNextStep(t,n,g){let d=this.getBouncePath(t,this.startX,this.startY,300,g,this.count,this.countMax);this.setPosition(d.x,d.y),this.count++}getP(t){this.vy+=this.gravity,this.y+=this.vy,this.y>t&&(this.y=t,this.vy*=-this.bounceFactor,Math.abs(this.vy)<.5&&(this.vy=0))}}function N({startSeconds:s,onFinish:t}){const[n,g]=a.useState(s),[d,i]=a.useState(!0);return a.useEffect(()=>{if(!d)return;if(n<=0){i(!1),t();return}const v=setInterval(()=>{g(S=>S-1)},1e3);return()=>clearInterval(v)},[n,d]),d?e.jsxs("span",{children:["..",n]}):null}const w=new WebSocket("ws://localhost:3001");w.onopen=()=>{};let j=!1;function F(s){j||(console.log("受信イベント登録"),w.removeEventListener("message",s),w.addEventListener("message",s),j=!0)}function C(s){try{return w.send(JSON.stringify(s)),"OK"}catch(t){return t}}function D(){const[s,t]=a.useState(""),[n,g]=a.useState(null),[d,i]=a.useState(""),[v,S]=a.useState(0),[c,l]=a.useState(new Date),[y,m]=a.useState(!0),[h,o]=a.useState(!1);function r(f){if(n==null||n.value==""||(console.log("stateShow:",h),h))return;m(!1);const x={type:f,message:s};try{const p=C(x);console.log(p)}catch(p){console.log(p)}o(!0),l(new Date),n.value="",t("")}F(f=>{const x=JSON.parse(f.data),p={type:x.type,message:x.message,start:new Date};console.log("受信：",p),i(p),v>100?S(0):S(v+1)});function u(f){g(f),t(f.value)}return e.jsxs("div",{className:"stage",children:[e.jsxs("div",{className:"viewMessage",children:[e.jsx(E,{}),e.jsx(R,{newMessage:d})]}),e.jsxs("div",{className:"frames",children:["ここでメッセージを送信するよ",e.jsx("span",{id:"state",children:h&&e.jsx(N,{startSeconds:10,onFinish:()=>o(!1)},new Date)}),e.jsx("br",{}),e.jsx("div",{children:e.jsx("input",{type:"text",className:"textBox",placeholder:"なにをおくろう...",maxLength:30,value:s,onChange:f=>u(f.target)})}),e.jsx("div",{children:e.jsx("span",{className:"button",onClick:()=>r(1),children:"おくる"})})]})]})}b.createRoot(document.getElementById("root")).render(e.jsx(a.StrictMode,{children:e.jsx(D,{})}));
